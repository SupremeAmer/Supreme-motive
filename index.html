<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supreme Motive - Affiliate Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite"></script>
  <script src="appwrite-config.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-indigo-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Supreme Motive</h1>
    <div id="userDropdown" class="relative">
      <button onclick="toggleDropdown()" class="bg-indigo-700 px-3 py-1 rounded">ü§µüèª Profile</button>
      <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white border rounded shadow">
        <a href="#" onclick="logout()" class="block px-4 py-2 hover:bg-gray-100">Logout</a>
      </div>
    </div>
  </header>

  <main class="p-4">
    <section class="mb-4">
      <h2 class="text-lg font-semibold mb-2">Wallet</h2>
      <p id="walletBalance">Balance: ‚Ç¶0</p>
      <p id="refLink" class="text-sm text-blue-600"></p>
    </section>

    <section class="mb-4">
      <h2 class="text-lg font-semibold mb-2">Referral Analytics</h2>
      <ul id="referralStats" class="text-sm"></ul>
    </section>

    <section class="mb-4">
      <h2 class="text-lg font-semibold mb-2">Request Withdrawal</h2>
      <form onsubmit="submitWithdrawal(event)" class="space-y-2">
        <input type="number" id="amount" placeholder="Amount" class="w-full p-2 border rounded" required />
        <input type="text" id="bank" placeholder="Bank Details" class="w-full p-2 border rounded" required />
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Submit</button>
      </form>
    </section>

    <section class="mb-4">
      <h2 class="text-lg font-semibold mb-2">Withdrawal History</h2>
      <ul id="withdrawalHistory" class="text-sm"></ul>
    </section>

    <section class="mb-4">
      <h2 class="text-lg font-semibold mb-2">Available Products</h2>
      <div id="productList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <section id="adminPanel" class="mb-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Admin Panel</h2>
      <form onsubmit="uploadProduct(event)" class="space-y-2">
        <input type="text" id="productName" placeholder="Product Name" class="w-full p-2 border rounded" required />
        <input type="url" id="productLink" placeholder="Product Link" class="w-full p-2 border rounded" required />
        <input type="number" id="productReward" placeholder="Reward Amount" class="w-full p-2 border rounded" required />
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Upload</button>
      </form>
    </section>
  </main>

  <footer class="bg-gray-200 text-center p-4 mt-8">
    &copy; 2025 Supreme Motive
  </footer>

  <script>
    const userId = localStorage.getItem("userId");
    let userEmail = "";

    function toggleDropdown() {
      document.getElementById("dropdownMenu").classList.toggle("hidden");
    }

    async function logout() {
      await account.deleteSession("current");
      window.location.href = "login.html";
    }

    async function loadDashboard() {
      try {
        const user = await account.get();
        userEmail = user.email;
        if (["supremealpha04@gmail.com", "emmyplumbingserivce@gmail.com", "funkomark24@gmail.com"].includes(userEmail)) {
          document.getElementById("adminPanel").classList.remove("hidden");
        }

        // Wallet
        const wallet = await database.getDocument(DB, walletsCol, userId);
        document.getElementById("walletBalance").innerText = `Balance: ‚Ç¶${wallet.balance}`;
        document.getElementById("refLink").innerText = `Referral Link: https://yourdomain.com/signup.html?ref=${userId}`;

        // Referral stats
        const referrals = await database.listDocuments(DB, referralsCol, [Appwrite.Query.equal("referredBy", userId)]);
        const refStats = referrals.documents.map(r => `<li>${r.buyerId} - ‚Ç¶${r.reward}</li>`).join('');
        document.getElementById("referralStats").innerHTML = refStats || "No referrals yet.";

        // Withdrawal history
        const withdrawals = await database.listDocuments(DB, withdrawalsCol, [Appwrite.Query.equal("userId", userId)]);
        const withdrawList = withdrawals.documents.map(w => `<li>‚Ç¶${w.amount} - ${w.status}</li>`).join('');
        document.getElementById("withdrawalHistory").innerHTML = withdrawList || "No history yet.";

        // Product list
        const products = await database.listDocuments(DB, productsCol);
        document.getElementById("productList").innerHTML = products.documents.map(p => `
          <div class="p-4 border rounded shadow">
            <h3 class="font-bold">${p.name}</h3>
            <p>Reward: ‚Ç¶${p.reward}</p>
            <a href="${p.link}" target="_blank" class="text-blue-600">Promote</a>
          </div>`).join('');
      } catch (err) {
        console.error("Error loading dashboard:", err);
        window.location.href = "login.html";
      }
    }

    async function submitWithdrawal(e) {
      e.preventDefault();
      const amount = document.getElementById("amount").value;
      const bank = document.getElementById("bank").value;
      await database.createDocument(DB, withdrawalsCol, ID.unique(), {
        userId,
        amount,
        bank,
        status: "pending"
      });
      alert("Withdrawal request sent.");
    }

    async function uploadProduct(e) {
      e.preventDefault();
      await database.createDocument(DB, productsCol, ID.unique(), {
        name: document.getElementById("productName").value,
        link: document.getElementById("productLink").value,
        reward: Number(document.getElementById("productReward").value)
      });
      alert("Product uploaded.");
    }

    loadDashboard();
  </script>
</body>
</html>


